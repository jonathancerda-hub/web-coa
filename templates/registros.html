{% extends "base.html" %}

{% block title %}Registros de Certificados{% endblock %}

{% block content %}

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0 fw-bold" style="color: #343a40;"><i class="bi bi-list-task me-2"></i>Registros de Certificados</h1>
    <form method="GET" action="{{ url_for('registros') }}" class="d-flex">
        <input class="form-control me-2" type="search" placeholder="Buscar en todos los registros..." id="liveSearchInput" name="search" value="{{ search_term }}">
        <a href="{{ url_for('registros') }}" class="btn btn-outline-secondary" title="Limpiar búsqueda y recargar"><i class="bi bi-x-lg"></i></a>
    </form>
    </div>

    <!-- INICIO DE LA MODIFICACIÓN: Estilos para la cabecera fija -->
    <style>
        .table-responsive thead th {
            position: sticky;
            top: 0; /* Se pega en la parte superior */
            background-color: #e9ecef; /* Un fondo gris claro, estándar de Bootstrap */
            z-index: 10; /* Se asegura que la cabecera esté por encima del contenido de la tabla */
            border-color: #dee2e6; /* Color de borde consistente */
            border-width: 1px;
        }
    </style>
    <!-- FIN DE LA MODIFICACIÓN -->

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Producto</th>
                    <th>Lote</th>
                    <th>Conclusión</th>
                    <th class="text-center">Fecha de Registro</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody id="recordsTableBody">
                {% include '_registros_table_rows.html' %}
            </tbody>
        </table>
    </div>

<div id="paginationContainer">
    {% include '_pagination.html' %}
</div>

<!-- INICIO DE LA MODIFICACIÓN: Script para búsqueda en vivo -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('liveSearchInput');
    const tableBody = document.getElementById('recordsTableBody');
    const paginationContainer = document.getElementById('paginationContainer');
    let searchTimeout;

    searchInput.addEventListener('keyup', function() {
        clearTimeout(searchTimeout);
        // Espera 300ms después de que el usuario deja de escribir para buscar
        searchTimeout = setTimeout(() => {
            const searchTerm = searchInput.value;
            const url = `{{ url_for('registros') }}?search=${encodeURIComponent(searchTerm)}`;

            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                tableBody.innerHTML = data.table_html;
                paginationContainer.innerHTML = data.pagination_html;
            })
            .catch(error => console.error('Error en la búsqueda:', error));
        }, 300);
    });
});
</script>
<!-- FIN DE LA MODIFICACIÓN -->

{% endblock %}